import _extends from "@babel/runtime/helpers/esm/extends";
import * as React from 'react';
import { unstable_useForkRef as useForkRef } from '@mui/utils';
<<<<<<< HEAD
import useList from '../useList';
import { useCompoundParent } from '../utils/useCompound';
import menuReducer from './menuReducer';

=======
import useListbox, { defaultListboxReducer, ActionTypes } from '../useListbox';
import useMenuChangeNotifiers from '../MenuUnstyled/useMenuChangeNotifiers';
function stateReducer(state, action) {
  if (action.type === ActionTypes.blur || action.type === ActionTypes.optionHover || action.type === ActionTypes.setValue) {
    return state;
  }
  var newState = defaultListboxReducer(state, action);
  if (action.type !== ActionTypes.setHighlight && newState.highlightedValue === null && action.props.options.length > 0) {
    return _extends({}, newState, {
      highlightedValue: action.props.options[0]
    });
  }
  return newState;
}
>>>>>>> main
/**
 *
 * Demos:
 *
 * - [Unstyled Menu](https://mui.com/base/react-menu/#hooks)
 *
 * API:
 *
 * - [useMenu API](https://mui.com/base/react-menu/hooks-api/#use-menu)
 */
export default function useMenu() {
  var parameters = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
<<<<<<< HEAD
  var defaultOpen = parameters.defaultOpen,
    listboxRefProp = parameters.listboxRef,
    openProp = parameters.open,
    onOpenChange = parameters.onOpenChange;
  var listboxRef = React.useRef(null);
  var handleRef = useForkRef(listboxRef, listboxRefProp);
  var _useCompoundParent = useCompoundParent(),
    subitems = _useCompoundParent.subitems,
    compoundComponentContextValue = _useCompoundParent.contextValue;
  var subitemKeys = React.useMemo(function () {
    return Array.from(subitems.keys());
  }, [subitems]);
  var getItemDomElement = React.useCallback(function (itemId) {
    var _subitems$get$ref$cur, _subitems$get;
    if (itemId == null) {
      return null;
    }
    return (_subitems$get$ref$cur = (_subitems$get = subitems.get(itemId)) == null ? void 0 : _subitems$get.ref.current) != null ? _subitems$get$ref$cur : null;
  }, [subitems]);
  var controlledProps = React.useMemo(function () {
    return {
      open: openProp
    };
  }, [openProp]);
  var stateChangeHandler = React.useCallback(function (event, field, fieldValue, reason, state) {
    if (field === 'open') {
      onOpenChange == null ? void 0 : onOpenChange(fieldValue);
      if (fieldValue === true && state.highlightedValue !== null) {
        var _subitems$get2, _subitems$get2$ref$cu;
        (_subitems$get2 = subitems.get(state.highlightedValue)) == null ? void 0 : (_subitems$get2$ref$cu = _subitems$get2.ref.current) == null ? void 0 : _subitems$get2$ref$cu.focus();
      }
    }
  }, [onOpenChange, subitems]);
  var _useList = useList({
      controlledProps: controlledProps,
      disabledItemsFocusable: true,
      focusManagement: 'DOM',
      getItemDomElement: getItemDomElement,
      getInitialState: function getInitialState() {
        return {
          selectedValues: [],
          highlightedValue: null,
          open: defaultOpen != null ? defaultOpen : false
        };
      },
      isItemDisabled: function isItemDisabled(id) {
        var _subitems$get3;
        return (subitems == null ? void 0 : (_subitems$get3 = subitems.get(id)) == null ? void 0 : _subitems$get3.disabled) || false;
      },
      items: subitemKeys,
      itemStringifier: function itemStringifier(id) {
        var _subitems$get4, _subitems$get5, _subitems$get5$ref$cu;
        return ((_subitems$get4 = subitems.get(id)) == null ? void 0 : _subitems$get4.label) || ((_subitems$get5 = subitems.get(id)) == null ? void 0 : (_subitems$get5$ref$cu = _subitems$get5.ref.current) == null ? void 0 : _subitems$get5$ref$cu.innerText);
      },
      listRef: handleRef,
      onStateChange: stateChangeHandler,
      reducerActionContext: {
        listboxRef: listboxRef
      },
      selectionMode: 'none',
      stateReducer: menuReducer
    }),
    dispatch = _useList.dispatch,
    getRootProps = _useList.getRootProps,
    listContextValue = _useList.contextValue,
    _useList$state = _useList.state,
    open = _useList$state.open,
    highlightedValue = _useList$state.highlightedValue;
  React.useEffect(function () {
    if (open && highlightedValue === subitemKeys[0]) {
      var _subitems$get6, _subitems$get6$ref, _subitems$get6$ref$cu;
      (_subitems$get6 = subitems.get(subitemKeys[0])) == null ? void 0 : (_subitems$get6$ref = _subitems$get6.ref) == null ? void 0 : (_subitems$get6$ref$cu = _subitems$get6$ref.current) == null ? void 0 : _subitems$get6$ref$cu.focus();
    }
  }, [open, highlightedValue, subitems, subitemKeys]);
  React.useEffect(function () {
    var _listboxRef$current;
    // set focus to the highlighted item (but prevent stealing focus from other elements on the page)
    if ((_listboxRef$current = listboxRef.current) != null && _listboxRef$current.contains(document.activeElement) && highlightedValue !== null) {
      var _subitems$get7, _subitems$get7$ref$cu;
      subitems == null ? void 0 : (_subitems$get7 = subitems.get(highlightedValue)) == null ? void 0 : (_subitems$get7$ref$cu = _subitems$get7.ref.current) == null ? void 0 : _subitems$get7$ref$cu.focus();
    }
  }, [highlightedValue, subitems]);
  var getListboxProps = function getListboxProps() {
    var otherHandlers = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    var rootProps = getRootProps(otherHandlers);
=======
  var listboxRefProp = parameters.listboxRef,
    _parameters$open = parameters.open,
    open = _parameters$open === void 0 ? false : _parameters$open,
    onClose = parameters.onClose,
    listboxId = parameters.listboxId;
  var _React$useState = React.useState({}),
    menuItems = _React$useState[0],
    setMenuItems = _React$useState[1];
  var listboxRef = React.useRef(null);
  var handleRef = useForkRef(listboxRef, listboxRefProp);
  var registerItem = React.useCallback(function (id, metadata) {
    setMenuItems(function (previousState) {
      var newState = _extends({}, previousState);
      newState[id] = metadata;
      return newState;
    });
  }, []);
  var unregisterItem = React.useCallback(function (id) {
    setMenuItems(function (previousState) {
      var newState = _extends({}, previousState);
      delete newState[id];
      return newState;
    });
  }, []);
  var _useMenuChangeNotifie = useMenuChangeNotifiers(),
    notifyHighlightChanged = _useMenuChangeNotifie.notifyHighlightChanged,
    registerHighlightChangeHandler = _useMenuChangeNotifie.registerHighlightChangeHandler;
  var _useListbox = useListbox({
      options: Object.keys(menuItems),
      optionStringifier: function optionStringifier(id) {
        var _menuItems$id$ref$cur;
        return menuItems[id].label || ((_menuItems$id$ref$cur = menuItems[id].ref.current) == null ? void 0 : _menuItems$id$ref$cur.innerText);
      },
      isOptionDisabled: function isOptionDisabled(id) {
        var _menuItems$id;
        return (menuItems == null ? void 0 : (_menuItems$id = menuItems[id]) == null ? void 0 : _menuItems$id.disabled) || false;
      },
      listboxRef: handleRef,
      focusManagement: 'DOM',
      id: listboxId,
      stateReducer: stateReducer,
      selectionLimit: 0,
      disabledItemsFocusable: true
    }),
    getOptionState = _useListbox.getOptionState,
    getOptionProps = _useListbox.getOptionProps,
    getRootProps = _useListbox.getRootProps,
    highlightedOption = _useListbox.highlightedOption,
    setListboxHighlight = _useListbox.setHighlightedValue;
  React.useEffect(function () {
    notifyHighlightChanged(highlightedOption);
  }, [highlightedOption, notifyHighlightChanged]);
  var highlightFirstItem = React.useCallback(function () {
    if (Object.keys(menuItems).length > 0) {
      setListboxHighlight(menuItems[Object.keys(menuItems)[0]].id);
    }
  }, [menuItems, setListboxHighlight]);
  var highlightLastItem = React.useCallback(function () {
    if (Object.keys(menuItems).length > 0) {
      setListboxHighlight(menuItems[Object.keys(menuItems)[Object.keys(menuItems).length - 1]].id);
    }
  }, [menuItems, setListboxHighlight]);
  React.useEffect(function () {
    if (!open) {
      highlightFirstItem();
    }
  }, [open, highlightFirstItem]);
  var createHandleKeyDown = function createHandleKeyDown(otherHandlers) {
    return function (e) {
      var _otherHandlers$onKeyD;
      (_otherHandlers$onKeyD = otherHandlers.onKeyDown) == null ? void 0 : _otherHandlers$onKeyD.call(otherHandlers, e);
      if (e.defaultPrevented) {
        return;
      }
      if (e.key === 'Escape' && open) {
        onClose == null ? void 0 : onClose();
      }
    };
  };
  var createHandleBlur = function createHandleBlur(otherHandlers) {
    return function (e) {
      var _otherHandlers$onBlur, _listboxRef$current;
      (_otherHandlers$onBlur = otherHandlers.onBlur) == null ? void 0 : _otherHandlers$onBlur.call(otherHandlers, e);
      if (!((_listboxRef$current = listboxRef.current) != null && _listboxRef$current.contains(e.relatedTarget))) {
        onClose == null ? void 0 : onClose();
      }
    };
  };
  React.useEffect(function () {
    var _listboxRef$current2;
    // set focus to the highlighted item (but prevent stealing focus from other elements on the page)
    if ((_listboxRef$current2 = listboxRef.current) != null && _listboxRef$current2.contains(document.activeElement) && highlightedOption !== null) {
      var _menuItems$highlighte, _menuItems$highlighte2;
      menuItems == null ? void 0 : (_menuItems$highlighte = menuItems[highlightedOption]) == null ? void 0 : (_menuItems$highlighte2 = _menuItems$highlighte.ref.current) == null ? void 0 : _menuItems$highlighte2.focus();
    }
  }, [highlightedOption, menuItems]);
  var getListboxProps = function getListboxProps() {
    var otherHandlers = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    var rootProps = getRootProps(_extends({}, otherHandlers, {
      onBlur: createHandleBlur(otherHandlers),
      onKeyDown: createHandleKeyDown(otherHandlers)
    }));
>>>>>>> main
    return _extends({}, otherHandlers, rootProps, {
      role: 'menu'
    });
  };
<<<<<<< HEAD
  React.useDebugValue({
    subitems: subitems,
    highlightedValue: highlightedValue
  });
  return {
    contextValue: _extends({}, compoundComponentContextValue, listContextValue),
    dispatch: dispatch,
    getListboxProps: getListboxProps,
    highlightedValue: highlightedValue,
    menuItems: subitems,
    open: open
=======
  var getItemState = React.useCallback(function (id) {
    var _getOptionState = getOptionState(id),
      disabled = _getOptionState.disabled,
      highlighted = _getOptionState.highlighted;
    return {
      disabled: disabled,
      highlighted: highlighted
    };
  }, [getOptionState]);
  React.useDebugValue({
    menuItems: menuItems,
    highlightedOption: highlightedOption
  });
  var contextValue = React.useMemo(function () {
    return {
      getItemProps: getOptionProps,
      getItemState: getItemState,
      registerHighlightChangeHandler: registerHighlightChangeHandler,
      registerItem: registerItem,
      unregisterItem: unregisterItem,
      open: open
    };
  }, [getOptionProps, getItemState, registerHighlightChangeHandler, registerItem, unregisterItem, open]);
  return {
    contextValue: contextValue,
    getListboxProps: getListboxProps,
    highlightedOption: highlightedOption,
    highlightFirstItem: highlightFirstItem,
    highlightLastItem: highlightLastItem,
    menuItems: menuItems
>>>>>>> main
  };
}